#!/usr/bin/env zsh

setopt errreturn nounset pipefail

SCRIPT_PATH="$(dirname $(realpath $0))"
SCRIPT_NAME="$(basename $0)"

source ${SCRIPT_PATH}/../lib/system.inc.sh
source ${SCRIPT_PATH}/../lib/colors.inc.sh
source ${SCRIPT_PATH}/../lib/hr-to-bytes.inc.sh
source ${SCRIPT_PATH}/../lib/is-yes.inc.sh
source ${SCRIPT_PATH}/../lib/yaml.inc.sh

if [ "$(uname -s)" != "FreeBSD" ]; then
    error "Must be executed on FreeBSD."
    exit 1
fi

BSDKIT_PATH="$(realpath ${SCRIPT_PATH}/../)"

if [ -x /usr/local/bin/vim ]; then
    export EDITOR=/usr/local/bin/vim
fi

# ===========================================================================

DEFAULT_VERSION=14
DEFAULT_ARCH=amd64

BUILD_PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin

: ${BSDKIT_SKIP_OCI:=1}

unset POSIXLY_CORRECT

if [ $(whoami) != "root" ]; then
    error "Must be executed as root."
    exit 1
fi

show_help() {
    cat << EOF

${SCRIPT_NAME} - Build FreeBSD releases, ISOs, USB images, and VM images

USAGE:
    ${SCRIPT_NAME} [OPTIONS]

OPTIONS:
    -h                  Show this help message

  Build Targets:
    -R                  Build release (world, kernel, packages, OCI, VM images)
    -S                  Build staging area
    -I                  Build ISO image
    -U                  Build USB image
    -V                  Build VM images (regular and cloud-init)
    -A                  Build all: release/staging/ISO/USB

  Build Configuration:
    -v VERSION          FreeBSD version (default: ${DEFAULT_VERSION})
    -a ARCH             Target architecture (default: ${DEFAULT_ARCH})
    -j JOBS             Number of parallel jobs for make
    -P                  Include packages in ISO/USB images

  VM Image Options:
    -M FORMATS          VM image formats, space-separated (default: qcow2)
                        Available: qcow2, raw, vmdk, vhd
    -Q SIZE             VM disk size (default: 10g)
    -W SIZE             VM swap size (default: 2g)

EXAMPLES:
    # Build complete release with all components
    ${SCRIPT_NAME} -v 14 -a amd64 -j 16 -A

    # Build VM images (regular and cloud-init)
    ${SCRIPT_NAME} -v 14 -a amd64 -V

    # Build VM images in multiple formats with custom size
    ${SCRIPT_NAME} -v 14 -a amd64 -V -M "qcow2 raw vmdk" -Q 20g -W 4g

    # Build ISO with packages included
    ${SCRIPT_NAME} -v 14 -a amd64 -P -I

VM IMAGE TYPES:
    -V builds both regular and cloud-init VM images for UFS and ZFS:

    Regular:            bsdkit-\${version}-\${arch}.(ufs|zfs).\${format}
    Cloud-init:         bsdkit-\${version}-\${arch}-cloudinit.(ufs|zfs).\${format}
                        (includes config-drive, growfs, DHCP, serial console)

DIRECTORIES:
    Source:             \$BSDKIT_DATA/src/\${version}/src
    Release:            \$BSDKIT_DATA/src/\${version}/release-\${arch}
    Staging:            \$BSDKIT_DATA/staging-\${version}-\${arch}
    ISO/USB:            \$BSDKIT_DATA/iso/
    VM images:          \$BSDKIT_DATA/vmimages-\${version}-\${arch}

EOF
}

# Allow -h to work without root
for arg in "$@"; do
    if [ "$arg" = "-h" ]; then
        show_help
        exit 0
    fi
done

if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

_version=${DEFAULT_VERSION}
_arch=${DEFAULT_ARCH}
_jobs_option=""
_with_packages=""

_build_release=""
_build_staging=""
_build_iso=""
_build_usb=""
_build_vmimage=""

_vm_formats="qcow2"
_vm_size="10g"
_vm_swapsize="2g"

OPTIND=1
while getopts "hv:a:j:M:Q:W:PRSIVUA" OPT; do
    case ${OPT} in
        h)
            show_help
            exit 0
            ;;
        v)
            _version="${OPTARG}"
            ;;
        a)
            _arch="${OPTARG}"
            ;;
        j)
            _jobs_option="-j${OPTARG}"
            ;;
        M)
            _vm_formats="${OPTARG}"
            ;;
        Q)
            _vm_size="${OPTARG}"
            ;;
        W)
            _vm_swapsize="${OPTARG}"
            ;;
        P)
            _with_packages="YES"
            ;;
        R)
            _build_release="YES"
            ;;
        S)
            _build_staging="YES"
            ;;
        I)
            _build_iso="YES"
            ;;
        U)
            _build_usb="YES"
            ;;
        V)
            _build_vmimage="YES"
            ;;
        A)
            _build_release="YES"
            _build_staging="YES"
            _build_iso="YES"
            _build_usb="YES"
            ;;
        *)
            show_help
            exit 1
            ;;
    esac
done

shift $((OPTIND - 1))

# ===

OS_SRCDIR=${BSDKIT_DATA}/src/${_version}/src

if [ ! -d "${OS_SRCDIR}" ]; then
    error "Source directory not found: ${OS_SRCDIR}"
    exit 1
fi

OS_RELDIR=${BSDKIT_DATA}/src/${_version}/release-${_arch}
OS_REPODIR=${BSDKIT_DATA}/pkgbase

OS_MAJOR=$(get-src-major-version ${OS_SRCDIR})
OS_MINOR=$(get-src-minor-version ${OS_SRCDIR})
OS_PATCH=$(get-src-patch-version ${OS_SRCDIR})

# ===

_current_step=""

run-step() {
    local step_name="$1"
    shift
    _current_step="${step_name}"
    message "[${step_name}] Starting: $(date "+%Y-%m-%d %H:%M:%S")"
    if "$@"; then
        message "[${step_name}] Completed: $(date "+%Y-%m-%d %H:%M:%S")"
        return 0
    else
        local rc=$?
        error "[${step_name}] FAILED (exit code ${rc}): $(date "+%Y-%m-%d %H:%M:%S")"
        return ${rc}
    fi
}

build-release() {
    local _make_conf=${BSDKIT_PATH}/etc/make.conf
    local _src_conf=${BSDKIT_PATH}/etc/src.conf

    KERNCONF="GENERIC"

    message "Build release started: $(date "+%Y-%m-%d %H:%M:%S")"
    message "Source: ${OS_SRCDIR}"
    message "Target: ${_arch} / KERNCONF=${KERNCONF}"

    run-step "buildworld+buildkernel" \
        env -i PATH=${BUILD_PATH} make -s -C ${OS_SRCDIR} \
            __MAKE_CONF=${_make_conf} SRCCONF=${_src_conf} TARGET=${_arch} TARGET_ARCH=${_arch} KERNCONF="${KERNCONF}" \
            ${_jobs_option} buildworld buildkernel

    run-step "release" \
        env -i PATH=${BUILD_PATH} make -s -C ${OS_SRCDIR}/release \
            __MAKE_CONF=${_make_conf} SRCCONF=${_src_conf} TARGET=${_arch} TARGET_ARCH=${_arch} KERNCONF="${KERNCONF}" \
            release NOPORTS="YES"

    message "[prepare-reldir] Preparing ${OS_RELDIR}"
    rm -r -f ${OS_RELDIR}
    mkdir -p ${OS_RELDIR}

    if [ -z "${BSDKIT_SKIP_PACKAGES:-}" ]; then
        run-step "packages" \
            env -i PATH=${BUILD_PATH} make -s -C ${OS_SRCDIR} \
                __MAKE_CONF=${_make_conf} SRCCONF=${_src_conf} TARGET=${_arch} TARGET_ARCH=${_arch} KERNCONF="${KERNCONF}" \
                ${_jobs_option} packages REPODIR=${OS_REPODIR}
    else
        message "[packages] Skipped (BSDKIT_SKIP_PACKAGES is set)"
    fi

    if [ -z "${BSDKIT_SKIP_OCI:-}" ]; then
        run-step "oci-release" \
            env -i PATH=${BUILD_PATH} make -s -C ${OS_SRCDIR}/release \
                __MAKE_CONF=${_make_conf} SRCCONF=${_src_conf} TARGET=${_arch} TARGET_ARCH=${_arch} KERNCONF="${KERNCONF}" \
                WITH_OCIIMAGES=yes oci-release
    else
        message "[oci-release] Skipped (BSDKIT_SKIP_OCI is set)"
    fi

    run-step "install" \
        env -i PATH=${BUILD_PATH} make -s -C ${OS_SRCDIR}/release \
            __MAKE_CONF=${_make_conf} SRCCONF=${_src_conf} TARGET=${_arch} TARGET_ARCH=${_arch} KERNCONF="${KERNCONF}" \
            install DESTDIR=${OS_RELDIR}

    message "[post-install] Generating RELEASE file"
    get-src-osrelease ${OS_SRCDIR} > ${OS_RELDIR}/ftp/RELEASE

    message "[post-install] Building etcupdate tarball"
    etcupdate build -s ${OS_SRCDIR} ${OS_RELDIR}/ftp/etcupdate.tar.bz2

    message "[post-install] Generating OLDFILES list"
    echo -n > ${OS_RELDIR}/ftp/OLDFILES
    env -i PATH=${BUILD_PATH} make -s -C ${OS_SRCDIR} list-old-files | sed 's/^/old-files: /' >> ${OS_RELDIR}/ftp/OLDFILES
    env -i PATH=${BUILD_PATH} make -s -C ${OS_SRCDIR} list-old-dirs | sed 's/^/old-dirs: /' >> ${OS_RELDIR}/ftp/OLDFILES
    env -i PATH=${BUILD_PATH} make -s -C ${OS_SRCDIR} list-old-libs | sed 's/^/old-libs: /' >> ${OS_RELDIR}/ftp/OLDFILES

    run-step "clean" \
        env -i PATH=${BUILD_PATH} make -s -C ${OS_SRCDIR}/release \
            __MAKE_CONF=${_make_conf} SRCCONF=${_src_conf} TARGET=${_arch} TARGET_ARCH=${_arch} KERNCONF="${KERNCONF}" \
            clean

    message "Build release completed: $(date "+%Y-%m-%d %H:%M:%S")"
}

build-staging() {
    local _target=${BSDKIT_DATA}/release-${_version}-${_arch}

    message "Build staging started: $(date "+%Y-%m-%d %H:%M:%S")"

    if [ -d "${OS_RELDIR}/ftp" ]; then
        message "[staging] Copying release files to ${_target}"
        if [ -d "${_target}" ]; then
            rm -r -f ${_target}
        fi

        mkdir -p ${_target}
        cp ${OS_RELDIR}/ftp/* ${_target}
    else
        message "[staging] No release files found at ${OS_RELDIR}/ftp"
    fi

    message "[staging] Running build-setup-staging"
    run-step "build-setup-staging" \
        ${BSDKIT_PATH}/bsdkit build-setup-staging \
            ${BSDKIT_DATA}/staging-${_version}-${_arch} \
            . \
            ${BSDKIT_DATA}/release-${_version}-${_arch} \
            ${BSDKIT_DATA}/packages-FreeBSD:${OS_MAJOR}:${_arch}-default-nox11

    message "Build staging completed: $(date "+%Y-%m-%d %H:%M:%S")"
}

build-iso() {
    local _iso=${BSDKIT_DATA}/iso/release-${_version}-${_arch}.iso
    local _release="none"
    local _packages="none"

    message "Build ISO started: $(date "+%Y-%m-%d %H:%M:%S")"

    if [ -n "${_with_packages}" ]; then
        _iso=${BSDKIT_DATA}/iso/release-${_version}-${_arch}.full.iso
        _release=${BSDKIT_DATA}/release-${_version}-${_arch}
        _packages=${BSDKIT_DATA}/packages-FreeBSD:${OS_MAJOR}:${_arch}-default-nox11
        message "[iso] Building full ISO with packages"
    else
        message "[iso] Building minimal ISO without packages"
    fi

    message "[iso] Output: ${_iso}"
    run-step "build-setup-iso" \
        ${BSDKIT_PATH}/bsdkit build-setup-iso \
            ${_iso} \
            ${BSDKIT_DATA}/staging-${_version}-${_arch} \
            ${_release} \
            ${_packages}

    message "Build ISO completed: $(date "+%Y-%m-%d %H:%M:%S")"
}

build-usb() {
    local _iso=${BSDKIT_DATA}/iso/release-${_version}-${_arch}.iso
    local _usb=${BSDKIT_DATA}/iso/release-${_version}-${_arch}.img

    message "Build USB started: $(date "+%Y-%m-%d %H:%M:%S")"

    if [ -n "${_with_packages}" ]; then
        _iso=${BSDKIT_DATA}/iso/release-${_version}-${_arch}.full.iso
        _usb=${BSDKIT_DATA}/iso/release-${_version}-${_arch}.full.img
        message "[usb] Building full USB image with packages"
    else
        message "[usb] Building minimal USB image"
    fi

    message "[usb] Input: ${_iso}"
    message "[usb] Output: ${_usb}"
    run-step "build-setup-img" \
        ${BSDKIT_PATH}/bsdkit build-setup-img ${_iso} ${_usb}

    message "Build USB completed: $(date "+%Y-%m-%d %H:%M:%S")"
}

build-vmimage() {
    local _make_conf=${BSDKIT_PATH}/etc/make.conf
    local _src_conf=${BSDKIT_PATH}/etc/src.conf
    local _vmimage_dir=${BSDKIT_DATA}/vmimages-${_version}-${_arch}
    local _objdir=/usr/obj${OS_SRCDIR}/${_arch}.${_arch}/release

    message "Build VM images started: $(date "+%Y-%m-%d %H:%M:%S")"
    message "[vmimage] Output directory: ${_vmimage_dir}"
    message "[vmimage] Formats: ${_vm_formats} / Size: ${_vm_size} / Swap: ${_vm_swapsize}"

    mkdir -p ${_vmimage_dir}

    # Build regular VM images
    message "[vmimage] Cleaning existing VM artifacts"
    chflags -R noschg ${_objdir}/vm-image-*(N) ${_objdir}/vm.*(N) 2>/dev/null || true
    rm -rf ${_objdir}/vm-image-*(N)
    rm -f ${_objdir}/vm.*.(img|qcow2|raw|vmdk|vhd)(N) ${_objdir}/*.(ufs|zfs).img(N) ${_objdir}/vm-image(N)

    run-step "vm-release" \
        env -i PATH=${BUILD_PATH} make -s -C ${OS_SRCDIR}/release \
            __MAKE_CONF=${_make_conf} SRCCONF=${_src_conf} \
            TARGET=${_arch} TARGET_ARCH=${_arch} \
            KERNEL="GENERIC" \
            WITH_VMIMAGES=YES \
            VMFSLIST="ufs zfs" \
            VMFORMATS="${_vm_formats}" \
            VMSIZE="${_vm_size}" \
            SWAPSIZE="${_vm_swapsize}" \
            WORLDDIR=${OS_SRCDIR} \
            vm-release

    # Copy VM images
    message "[vmimage] Installing VM images to ${_vmimage_dir}"
    for img in ${_objdir}/vm.*.(qcow2|raw|vmdk|vhd)(N); do
        if [ -f "${img}" ]; then
            local basename=$(basename ${img})
            local newname=$(echo ${basename} | sed "s/^vm\./bsdkit-${_version}-${_arch}./")
            cp -v ${img} ${_vmimage_dir}/${newname}
        fi
    done

    # Clean up regular VM build artifacts
    message "[vmimage] Cleaning up VM build artifacts"
    chflags -R noschg ${_objdir}/vm-image-*(N) 2>/dev/null || true
    rm -rf ${_objdir}/vm-image-*(N)
    rm -f ${_objdir}/vm.*.img(N) ${_objdir}/*.img(N) ${_objdir}/vm-image(N)

    # Build cloud-init enabled images using cloudware system
    message "[vmimage] Cleaning existing cloudware artifacts"
    chflags -R noschg ${_objdir}/cw-basic-cloudinit-*(N) ${_objdir}/basic-cloudinit.*(N) 2>/dev/null || true
    rm -rf ${_objdir}/cw-basic-cloudinit-*(N)
    rm -f ${_objdir}/basic-cloudinit.*.(img|qcow2|raw|vmdk|vhd)(N)

    run-step "cloudware-release" \
        env -i PATH=${BUILD_PATH} make -s -C ${OS_SRCDIR}/release \
            __MAKE_CONF=${_make_conf} SRCCONF=${_src_conf} \
            TARGET=${_arch} TARGET_ARCH=${_arch} \
            KERNEL="GENERIC" \
            WITH_CLOUDWARE=YES \
            CLOUDWARE="BASIC-CLOUDINIT" \
            VMFSLIST="ufs zfs" \
            VMSIZE="${_vm_size}" \
            SWAPSIZE="${_vm_swapsize}" \
            WORLDDIR=${OS_SRCDIR} \
            cloudware-release

    # Copy cloud-init images
    message "[vmimage] Installing CLOUDINIT VM images to ${_vmimage_dir}"
    for img in ${_objdir}/basic-cloudinit.*.(qcow2|raw|vmdk|vhd)(N); do
        if [ -f "${img}" ]; then
            local basename=$(basename ${img})
            local newname=$(echo ${basename} | sed "s/^basic-cloudinit\./bsdkit-${_version}-${_arch}-cloudinit./")
            cp -v ${img} ${_vmimage_dir}/${newname}
        fi
    done

    # Clean up cloudware build artifacts
    message "[vmimage] Cleaning up CLOUDINIT build artifacts"
    chflags -R noschg ${_objdir}/cw-basic-cloudinit-*(N) 2>/dev/null || true
    rm -rf ${_objdir}/cw-basic-cloudinit-*(N)
    rm -f ${_objdir}/basic-cloudinit.*.img(N)

    message "VM images created in: ${_vmimage_dir}"
    ls -lh ${_vmimage_dir}
}

if [ -n "${_build_release}" ]; then
    build-release
fi

if [ -n "${_build_staging}" ]; then
    build-staging
fi

if [ -n "${_build_iso}" ]; then
    build-iso
fi

if [ -n "${_build_usb}" ]; then
    build-usb
fi

if [ -n "${_build_vmimage}" ]; then
    if [ -z "${BSDKIT_SKIP_VM:-}" ]; then
        build-vmimage
    fi
fi
